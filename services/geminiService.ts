
import { GoogleGenAI } from "@google/genai";
import type { RecipeOutput, ImageFile } from '../types';

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const model = ai.models;

const mainPrompt = `
# –†–û–õ–¨ –ò –ó–ê–î–ê–ß–ê
–¢—ã ‚Äî –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –∏ –∏–ª–ª—é—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ ¬´–í–∫—É—Å–Ω–æ. –ü—Ä–æ—Å—Ç–æ. –ü–æ–ª–µ–∑–Ω–æ.¬ª. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç –¥–∏–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏/–∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –≥–æ—Ç–æ–≤—ã–π –ø–æ—Å—Ç –¥–ª—è Instagram.

# –ì–õ–ê–í–ù–´–ô –ü–†–ò–ù–¶–ò–ü
–ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞. –†–∞—Å—á—ë—Ç –ö–ë–ñ–£ —è–≤–ª—è–µ—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤. –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π, –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç, –æ—Å—Ç–∞–≤–ª—è–π –∏—Ö –ø—É—Å—Ç—ã–º–∏, –Ω–æ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ.

# –§–û–†–ú–ê–¢ –†–ï–ó–£–õ–¨–¢–ê–¢–ê
–¢–≤–æ–π –æ—Ç–≤–µ—Ç –î–û–õ–ñ–ï–ù –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ markdown-—Ä–∞–∑–º–µ—Ç–∫–∏ (\`\`\`json) –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ JSON –æ–±—ä–µ–∫—Ç–∞. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–ª–µ–¥—É—é—â–µ–π:
{
  "–ù–æ–º–µ—Ä": "...",
  "–ó–∞–≥–æ–ª–æ–≤–æ–∫": "...",
  "–†–µ—Ü–µ–ø—Ç": "...",
  "–°–æ–≤–µ—Ç": "...",
  "–î–æ–ø–ò–Ω—Ñ–∞": "...",
  "–î–∏–µ—Ç—ã": "...",
  "–•—ç—à—Ç–µ–≥–∏": "...",
  "–ü—Ä–æ–º–ø—Ç": "..."
}

# –î–ï–¢–ê–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ó–ê–ü–û–õ–ù–ï–ù–ò–Æ –ü–û–õ–ï–ô JSON:

1.  **–ù–æ–º–µ—Ä**:
    *   –ù–∞–π–¥–∏ –Ω–æ–º–µ—Ä —Ä–µ—Ü–µ–ø—Ç–∞ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ (–æ–±—ã—á–Ω–æ –æ–Ω –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ "–†–µ—Ü–µ–ø—Ç ‚Ññ ...").
    *   –ó–∞–ø–∏—à–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º –Ω–æ–º–µ—Ä. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ "–†–µ—Ü–µ–ø—Ç ‚Ññ 277", –≤ —ç—Ç–æ –ø–æ–ª–µ –∑–∞–ø–∏—à–∏ "277".
    *   –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ—Å—Ç–∞–≤—å –ø–æ–ª–µ –ø—É—Å—Ç—ã–º "".

2.  **–ó–∞–≥–æ–ª–æ–≤–æ–∫**:
    *   –ù–∞–π–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ –≤ —Ç–µ–∫—Å—Ç–µ –∏ –∑–∞–ø–∏—à–∏ –µ–≥–æ —Å—é–¥–∞. –≠—Ç–æ –±—É–¥–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞.
    *   –ï—Å–ª–∏ —è–≤–Ω–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–µ—Ç, –ø—Ä–∏–¥—É–º–∞–π –∫–æ—Ä–æ—Ç–∫–∏–π –∏ –∞–ø–ø–µ—Ç–∏—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤.

3.  **–†–µ—Ü–µ–ø—Ç**:
    *   –ù–∞–ø–∏—à–∏ –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Ä–µ—Ü–µ–ø—Ç–∞ –ø—Ä–æ—Å—Ç—ã–º, —Ç—ë–ø–ª—ã–º, —Å–ø–æ–∫–æ–π–Ω—ã–º —è–∑—ã–∫–æ–º. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Instagram.
    *   **–ù–µ –¥–æ–±–∞–≤–ª—è–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π** (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ü—Ä–∏–≤–µ—Ç!" –∏–ª–∏ "–°–µ–≥–æ–¥–Ω—è —É –Ω–∞—Å..."). –°—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞–π —Å –æ–ø–∏—Å–∞–Ω–∏—è –±–ª—é–¥–∞.
    *   **–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏** ü•ê‚ú®, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Ç–µ–∫—Å—Ç –±–æ–ª–µ–µ –∂–∏–≤—ã–º –∏ –∞–ø–ø–µ—Ç–∏—Ç–Ω—ã–º.
    *   –ò–∑–±–µ–≥–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞. –í–º–µ—Å—Ç–æ –Ω–∏—Ö –∏—Å–ø–æ–ª—å–∑—É–π –º—è–≥–∫–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏: ¬´–µ—Å–ª–∏ –≤–∞–∂–Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Å–∞—Ö–∞—Ä–æ–º¬ª, ¬´–¥–ª—è –ª—ë–≥–∫–æ–≥–æ —Ä–∞—Ü–∏–æ–Ω–∞¬ª, ¬´–ø–æ–¥—Ö–æ–¥–∏—Ç —Ç–µ–º, –∫—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ñ–ö–¢¬ª, ¬´–≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –∏–∑–±–µ–≥–∞–µ—Ç –∂–∞—Ä–µ–Ω–æ–≥–æ¬ª.
    *   –ù–ò–ö–û–ì–î–ê –Ω–µ —É–ø–æ–º–∏–Ω–∞–π –Ω–æ–º–µ—Ä–∞ –¥–∏–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–¥–∏–µ—Ç–∞ ‚Ññ5").
    *   –†–∞–∑–¥–µ–ª–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ 3‚Äì4 —á—ë—Ç–∫–∏—Ö —à–∞–≥–∞.
    *   –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∏–∫–∞–∫–æ–≥–æ **bold** –∏–ª–∏ *italic*). –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –∏ —ç–º–æ–¥–∑–∏.

4.  **–°–æ–≤–µ—Ç**:
    *   –°—é–¥–∞ –∑–∞–ø–∏—à–∏ –ø–æ–ª–µ–∑–Ω—ã–π —Å–æ–≤–µ—Ç, –ª–∞–π—Ñ—Ö–∞–∫ –∏–ª–∏ –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–°–æ—Ö—Ä–∞–Ω–∏ —Ä–µ—Ü–µ–ø—Ç ‚ù§Ô∏è'), –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –∏–¥—Ç–∏ –≤ –∫–æ–Ω—Ü–µ –ø–æ—Å—Ç–∞.

5.  **–î–æ–ø–ò–Ω—Ñ–∞**:
    *   –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–π –ö–ë–ñ–£ (–∫–∞–ª–æ—Ä–∏–∏, –±–µ–ª–∫–∏, –∂–∏—Ä—ã, —É–≥–ª–µ–≤–æ–¥—ã) –Ω–∞ –æ–¥–Ω—É –ø–æ—Ä—Ü–∏—é, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Å–ø–∏—Å–∫–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –∏ –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∏–∑ —Ä–µ—Ü–µ–ø—Ç–∞.
    *   –§–æ—Ä–º–∞—Ç: "–ö–ë–ñ–£ –Ω–∞ 1 –ø–æ—Ä—Ü–∏—é: ~ –ö: ... –∫–∫–∞–ª, –ë: ... –≥, –ñ: ... –≥, –£: ... –≥".
    *   –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–¥–µ–ª–∞—Ç—å –Ω–∞–∏–ª—É—á—à–∏–π –≤–æ–∑–º–æ–∂–Ω—ã–π —Ä–∞—Å—á—ë—Ç. –ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ –æ—Ç–≤–µ—á–∞—Ç—å, —á—Ç–æ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.

6.  **–î–∏–µ—Ç—ã**:
    *   –£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä–∞ –¥–∏–µ—Ç –∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ.
    *   –§–æ—Ä–º–∞—Ç: "–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–∏–µ—Ç: ‚Ññ5, ‚Ññ8. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –ø—Ä–∏ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è—Ö –ñ–ö–¢, –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Å–∞."
    *   –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –æ—Å—Ç–∞–≤—å –ø–æ–ª–µ –ø—É—Å—Ç—ã–º "".

7.  **–•—ç—à—Ç–µ–≥–∏**:
    *   –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ö—ç—à—Ç–µ–≥–∏: #–í–∫—É—Å–Ω–æ–ü—Ä–æ—Å—Ç–æ–ü–æ–ª–µ–∑–Ω–æ #—â–∞–¥—è—â–µ–µ–ø–∏—Ç–∞–Ω–∏–µ #–≤–∫—É—Å–Ω–æ–ø–æ–ª–µ–∑–Ω–æ
    *   –ï—Å–ª–∏ –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –Ω–æ–º–µ—Ä –¥–∏–µ—Ç—ã, –¥–æ–±–∞–≤—å —Ö—ç—à—Ç–µ–≥ –¥–ª—è –Ω–µ–≥–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, #–¥–∏–µ—Ç–∞5.

8.  **–ü—Ä–æ–º–ø—Ç**:
    *   –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∏–∑—É–∞–ª–∞ –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏.
    *   –û—Å–Ω–æ–≤—ã–≤–∞–π—Å—è –Ω–∞ –ø–æ–ª–µ "–ó–∞–≥–æ–ª–æ–≤–æ–∫" –∏ –≤–Ω–µ—à–Ω–µ–º –≤–∏–¥–µ –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞ –∏–∑ —Ä–µ—Ü–µ–ø—Ç–∞.
    *   –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–±–ª–æ–Ω, –∑–∞–ø–æ–ª–Ω–∏–≤ [–ù–ê–ó–í–ê–ù–ò–ï –ë–õ–Æ–î–ê] –∏ [–ö–†–ê–¢–ö–û–ï –û–ü–ò–°–ê–ù–ò–ï]: "Instagram post, 1080x1350 (4:5). Minimalist food photography, close-up shot of [–ù–ê–ó–í–ê–ù–ò–ï –ë–õ–Æ–î–ê], [–ö–†–ê–¢–ö–û–ï –û–ü–ò–°–ê–ù–ò–ï]. The dish is beautifully plated on a simple ceramic plate. Soft, natural daylight from a side window creates gentle shadows. The background is a cozy, slightly blurred home kitchen with light, neutral tones (white, beige, olive green). A linen napkin and a simple fork are placed beside the plate. The overall mood is warm, calm, and healthy. On the image, add elegant, readable text: Title - '[–ù–ê–ó–í–ê–ù–ò–ï –ë–õ–Æ–î–ê]', Subtitle - '–í–∫—É—Å–Ω–æ. –ü—Ä–æ—Å—Ç–æ. –ü–æ–ª–µ–∑–Ω–æ.'".

–í–æ—Ç —Ä–µ—Ü–µ–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:
`;


export const generateInstagramPost = async (text: string, images: ImageFile[]): Promise<RecipeOutput> => {
  const parts: ({ text: string } | { inlineData: { mimeType: string; data: string } })[] = [];

  if (text) {
    parts.push({ text: mainPrompt });
    parts.push({ text: text });
  } else {
    parts.push({ text: mainPrompt });
  }

  images.forEach(image => {
    parts.push({
      inlineData: {
        mimeType: image.type,
        data: image.base64,
      }
    });
  });

  const response = await ai.models.generateContent({
    model: 'gemini-2.5-flash',
    contents: { parts: parts },
    config: {
      responseMimeType: "application/json",
    },
  });

  const responseText = response.text.trim();
  
  try {
    const jsonResponse = JSON.parse(responseText);
    return jsonResponse as RecipeOutput;
  } catch (error) {
    console.error("Failed to parse Gemini response as JSON:", responseText);
    throw new Error("AI response was not valid JSON. Check the console for the raw response.");
  }
};
